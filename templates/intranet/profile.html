{% extends 'intranet/shared.html' %}
{% load staticfiles %}
{% load i18n %}
{% block css %}
	<link rel="stylesheet" type="text/css" href="{% static 'intranet/css/vendor/cropper.min.css' %}">
	<link href='https://fonts.googleapis.com/css?family=Product+Sans:400,400i,700,700i' rel='stylesheet' type='text/css'>
{% endblock %}
{% block extra_js %}
	{% if request.user == profile_user %}
		 <script src="{% static 'intranet/js/vendor/canvas-to-blob.min.js' %}"></script> 
		 <script src="{% static 'intranet/js/vendor/cropper.min.js' %}"></script> 
		 <script src="{% static 'intranet/js/profile.js' %}"></script>
	{% endif %} 
{% endblock %}
{% block content %}
<div class="title">
	<h3>{% blocktrans with first_name=profile_user.first_name last_name=profile_user.last_name %} 
			Perfil de {{ first_name }} {{ last_name }} 
		{% endblocktrans %}
	</h3>
</div>
<div class="intranet row">
    <!-- Seccion izquierda -->
    <div id="lCol" class="c5">
        <!-- Nueva linea -->
        <div class="intranet box">
        	<div class="profile image">	
        		<img 
        			{% if profile_user.profile_picture %} 
        				src="{% static profile_user.filename %}" 
        			{% else %} 
        				src="{% static 'intranet/images/default.png' %}" 
        			{% endif%}>
        	</div>
        	{% if request.user == profile_user %}
	        	<div class="profile btn">
	        		<a class="modal picture" href="#changeImgModal">{% trans "Cambiar imagen" %}</a>
	        	</div>
        	{% endif %}
        	<div class="document table">
        		<table>
					<tr>
						<td>{% trans "Nombre completo" %}:</td>
						<td>{{profile_user.first_name}} {{ profile_user.last_name }}</td>
					</tr>
					<tr>
						<td>{% trans "Institución" %}:</td>
						<td>{{ profile_user.institution }}</td>
					</tr>
					<tr>
						<td>{% trans "Carrera" %}:</td>
						<td>{{ profile_user.career }}</td>
					</tr>
					<tr>
						<td>{% trans "País" %}:</td>
						<td>{{ profile_user.country }}</td>
					</tr>
					<tr>
						<td>{% trans "Area" %}:</td>
						<td>{% trans profile_user.area.name %}</td>
					</tr>
				</table>  		
        	</div>
        </div>
        {% if request.user == profile_user %}
	        <!-- Nueva linea -->
	        <div class="intranet box">
	        	<div class="document table">
	        		<table class="profile options">
	        			<tr>
	        				<td class="linkDrive">
		        				<img src="{% static 'intranet/images/G-logo.png' %}">
		        				{% if profile_user.drive_credentials %}
		        					<span class="email">{{profile_user.drive_email}}</span>
		        					<a class="modal" href="#deauthenticateModal">{% trans 'Desvincular' %}</a>
		        				{% else %}
		        					<span class="email">{%trans 'No hay una cuenta asociada' %}</span>
		        					<a id="authenticate">{% trans 'Vincular' %}</a>
		        				{% endif %}
	        				</td>
	        			</tr>
		        		<tr><td><a class="modal edit" href="#editInformationModal">{% trans 'Editar información' %}</a></td></tr>
		        		<tr><td><a class="modal password" href="#passwordModal">{% trans 'Cambiar contraseña' %}</a></td></tr>
		        	</table>
	        	</div>
	        </div>
        {% endif %}
    </div>
    <!-- Seccion derecha -->
    <div id="rCol" class="c7">
    <!-- Nueva linea -->
        <div class="intranet box">
       		<div class="profile counter">
                <div>
                    <h1>{{ profile_user.doc_count }}</h1>
                    <h3>Documentos</h3>
                </div>
            </div>
            <div class="profile info">
            	<ul class="documents">
	            	{% for document in documents %}
	            		<li>
	            			{% if request.user == profile_user %}
		            			<div class="options" data-id="{{ document.id }}">
		            				<div>
		            					<button class="delete" data-title="{{document.title}}" data-author="{{document.author}}" title="{% trans 'Eliminar' %}"><i class="fa fa-trash-o" aria-hidden="true"></i></button>	            					
		            				</div>
		            				<div>
		            					<a href="{% url 'intranet:edit_document' document.author document.title %}" title="{% trans 'Editar' %}"><i class="fa fa-pencil-square-o" aria-hidden="true"></i></a>
		            				</div>
		            				<div>
		            					<!-- Boton 3 -->    					
		            				</div>
		            			</div>
		            		{% endif %}
	            			<div class="body">
	            				<a href="{% url 'intranet:document' document.author document.title %}">
	            					<h3><span>{{ document.date|date:"Y" }}</span> · {{ document.title }}</h3>
	            					<span>{{ document.author }}</span>
	            				</a>
	            			</div>
	            			{% if request.user == profile_user %}
	            				<div class="btn">
	            					<button data-id="{{ document.id }}"><i class="fa fa-ellipsis-v" aria-hidden="true"></i></button>
	            				</div>
	            			{% endif %}
	            		</li>
	            	{% endfor %}
            	</ul>
            </div>
            <!--
            <div class="description">
                <span>Alguna descripción</span>
            </div>
            -->
        </div>
    </div>
</div>
{% if request.user == profile_user %}
<!-- Modal para modificar la foto de perfil -->
<div id="changeImgModal" class="profile modal"  style="display:none!important; height:100%;">
	<div class="profile cropper">
		<button id="selectImage">
	  		<i class="fa fa-cloud-upload" aria-hidden="true"></i>
	  		<h5>{% trans 'Presiona para seleccionar' %}</h5>
  		</button>
  		<div class="editor" style="display:none; opacity:0; top:20px;">
	  		<div class="header">
  				<button class="c8" id="changeImage"><i class="fa fa-cloud-upload" aria-hidden="true"></i>{% trans 'Seleccionar nueva imagen' %}</button>
  				<button class="c4" id="sendImage"><i class="fa fa-paper-plane" aria-hidden="true"></i>{% trans 'Enviar' %}</button>
	  		</div>
  			<div class="profile image">	
        		<div><!-- Aqui va el preview de la imagen recortada --></div>
        	</div>
  			<div class="crop">
  				<img id="imageCropper">
  			</div>
  		</div>
	</div>
</div>
<input id="pictureField" type="file" accept="image/png, image/jpeg" style="display: none" name="picture">

<!-- Modal para desvincular la cuenta de Google -->
<div id="deauthenticateModal" class="document modal"  style="display:none!important">
	<h2>{% trans "¿Estas seguro?" %}</h2>
	<p>{% trans "Estas a punto de desvincular tu cuenta de Google: " %}</p>
	<h3>{{profile_user.drive_email}}</h3>
	<div><a href="{% url 'deauthenticate' 'intranet:profile' %}">CONFIRMAR</a></div>
</div>

<!-- Modal para modificar la informacion del perfil -->
<div id="editInformationModal" class="profile modal clear"  style="display:none!important">
	<h3>{% trans "Edita tu perfil" %}</h3>
	<form class="clear c12" action="{% url 'intranet:profile' %}" method="POST" >
		{% csrf_token %}
		<div class="row profile field">
			<span class="c12">{% trans 'Correo electronico' %}:</span>
            <div class="c12"><input value="{{ profile_user.email }}" type="email" name="email" class="text" placeholder="{% trans 'Correo electronico' %}" required readonly/></div>
         </div>
         <div class="row profile field">
			<span class="c12">{% trans 'Nombre' %}:</span>
         	<div class="c12"><input type="text" value="{{ profile_user.first_name }}" name="first_name" class="text" placeholder="{% trans 'Nombre' %}" required/></div>
         </div>
         <div class="row profile field">
			<span class="c12">{% trans 'Apellido' %}:</span>
     		<div class="c12"><input type="text" value="{{ profile_user.last_name }}" name="last_name" class="text" placeholder="{% trans 'Apellido' %}" required/></div>
     	</div>
         <div class="row profile field">
			<span class="c12">{% trans 'Institución' %}:</span>
         	<div class="c12"><input value="{{ profile_user.institution }}" type="text" name="institution" class="text" placeholder="{% trans 'Institución' %}" required/></div>
         </div>
     	<div class="row profile field">
			<span class="c12">{% trans 'Carrera' %}:</span>
     		<div class="c12"><input type="text" name="career" value="{{ profile_user.career }}"class="text" placeholder="{% trans 'Carrera' %}" required/></div>
     	</div>
     	<div class="row profile field">
			<span class="c12">{% trans 'Area' %}:</span>
     		<div class="c12">
     			<select name="area" required>
					<option disabled>{% trans "Selecciona un area" %}</option>
					{% for area in areas %}
						<option value="{{ area.id }}" {% if area == profile_user.area %} selected {% endif %}>{{ area.name }}</option>
					{% endfor %}
				</select>
     		</div>
     	</div>
		<div class="row profile field">
			<span class="c12">{% trans 'País' %}:</span>
			<div class="c12">
		       <select name="country" required>
		            <option disabled> {% trans 'Selecciona un país' %}</option>
		            {% include 'intranet/countries.html' %}
		       </select>
		  </div>
		</div>
         <div class="row profile field">
         	<div class="s6 c6"><input type="submit" class="submit trans"></div>
         </div>
	</form>
</div>

<!-- Modal para cambiar contraseña -->
<div id="passwordModal" class="profile modal clear" style="display:none !important;">
	<h3>{% trans "Cambio de contraseña" %}</h3>
	
	<form id="passwordForm">
		{% csrf_token %}
		<div class="row profile field">
			<div class="c12">
				<span>Contraseña actual:</span>
				<input id="current" type="password" class="text" name="current" required>
			</div>
		</div>
		<div class="intranet separator"></div>
		<div class="row profile field">
			<div class="c12">
				<span>Nueva contraseña:</span>
				<input id="new" type="password" class="text" name="new" required>
			</div>
		</div>
		<div class="row profile field">
			<div class="c12">
				<span>Ingresar nuevamente:</span>
				<input id="confirm" type="password" class="text" required>
			</div>
		</div>
		<div class="row profile field">
			<div class="c12">
				<input id="passSubmit" type="submit" class="submit trans">
			</div>
		</div>
	</form>
	<div class="row profile field">
		<div class="c12">
			<h5 class="message password"></h5>
		</div>
	</div>
</div>

<!-- Modal extra -->
<div style="display:none;">
	<div id="enablePopupModal">
		<h4>{%trans "¡Un momento!" %}</h4>
		<span>{% trans "Al parecer tienes deshabilitadas las ventanas emergentes." %}</span>
		<span>{% trans "Activalas, recarga la página y vuelve a intentarlo." %}</span>
	</div>
	<div>
		<div class="document modal" id="deleteModal">
			<h2>{% trans "¿Estas seguro?" %}</h2>
			<p>{% trans "Estas a punto de eliminar el documento:" %}</p>
			<h3 class="confirm" type="title" data=""></h3>
			<h5 class="confirm" type="author" data=""></h5>
			<div><a class="confirm" type="send">{% trans "CONFIRMAR" %}</a></div>
		</div>
	</div>
	<div>
		<div id="successModal">
			<i class="fa fa-check" aria-hidden="true"></i>
			<h3>{% trans "Cambio exitoso" %}</h3>
		</div>
	</div>
</div>

<script>
	var update_picture_url = "{% url 'intranet:update_picture' %}";
	var edit_document_url = "{% url 'intranet:edit_document' '888' '999' %}";
	var csrf_token = "{{ csrf_token }}";
	var authentication_url = "http://{{ request.get_host }}{% url 'get_credentials' %}";
	var password_url = "{% url 'change_password' %}";
</script>
<script src="{% static 'intranet/js/profile_events.js' %}"></script>
{% endif %}
{% endblock %}



<!-- ############################## -->
<!-- Comienzo de la version antigua -->
<!-- ############################## -->




<div id="pictures-section">
	<div id="background-picture">
		<img src="{% static 'intranet/images/background-picture2.png' %}">
	</div>
	<div id="profile-picture">
		{% if request.user == profile_user %} <div id="edit-btn-wrapper"><i class="fa fa-pencil-square-o"></i></div> {% endif %}
		<div id="picture-wrapper"><img id="picture-circle" {% if profile_user.profile_picture %} src="{% static profile_user.filename %}" {% else %} src="{% static 'intranet/images/default.png' %}" {% endif%}></div>
	</div>
	<button id="accept-btn" class="btn">{% trans "Aceptar" %}</button>
	<button id="cancel-btn" class="btn">{% trans "Cancelar" %}</button>
</div>
{% if request.user == profile_user %}
	<form id="picture_form"  action="{% url 'intranet:update_picture' %}" method="POST" style="display: none" enctype="multipart/form-data">
		<input id="picture-input" type="file" accept="image/png, image/jpeg" style="display: none" name="picture" required>
		{% csrf_token %}
	</form>
	<script>
	var prev_picture;
		$('#edit-btn-wrapper').click(function(){
			$('#picture-input').click();
		});

		$('#picture-input').change(function(){
			$('.btn').addClass('btn-visible');
			prev_picture = $('#picture-circle').attr('src');
			readURL(this);
		});

		$('#cancel-btn').click(function(){
			closeForm()
			$('#picture-circle').attr('src', prev_picture);
			$('.btn').removeClass('btn-visible');
		});

		$('#accept-btn').click(function(){
			$('#picture_form').submit();
		});
	</script>
{% endif %}
<div id="information-section">
	<table>
		<tr>
			<td>{% trans "Nombre completo" %}:</td>
			<td>{{profile_user.first_name}} {{ profile_user.last_name }}</td>
		</tr>
		<tr>
			<td>{% trans "Institución" %}:</td>
			<td>{{ profile_user.institution }}</td>
		</tr>
		<tr>
			<td>{% trans "Carrera" %}:</td>
			<td>{{ profile_user.career }}</td>
		</tr>
		<tr>
			<td>{% trans "País" %}:</td>
			<td>{{ profile_user.country }}</td>
		</tr>
		<tr>
			<td>{% trans "Area" %}:</td>
			<td>{% trans profile_user.area.name %}</td>
		</tr>
	</table>
</div>
{% if request.user == profile_user or request.user.is_admin %}
	<h3>{% trans "Mis documentos" %}</h3>
	{% if not documents %}
		<h5 class="documents-message" >{% trans "No posees documentos" %}</h5>
	{% else %}
		<div class="result">
			<table>
			<tr>
				<th class="col1">{% trans "Autor" %}</th>
				<th class="col2">{% trans "Titulo" %}</th>
				<th class="col3">{% trans "Año" %}</th>
				<th class="col4">{% trans "Tipo" %}</th>
				<th class="col5">{% trans "Añadido" %}</th>
			</tr>
			{% for document in documents%}
				<tr class="search-result" doc-title="{{ document.title }}" doc-author="{{ document.author }}">
					<td class="col1">{{ document.author }}</td>
					<td class="col2">{{ document.title }}</td>
					<td class="col3">{{ document.date|date:"Y" }}</td>
					<td class="col4">{% if document.type == False %} {% trans "Público" %} {% else %} {% trans "Privado" %} {% endif %}</td>
					<td class="col5">{{ document.date_added }}</td>
				</tr>
			{% endfor %}
			</table>
		</div>
	{% endif %}
{% endif %}
<div class="clear"></div>